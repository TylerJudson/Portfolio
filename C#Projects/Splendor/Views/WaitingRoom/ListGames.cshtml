@model List<Splendor.Models.IPotentialGame>
@{
    ViewData["Title"] = "Join Game";
}

<script>
    // Enters into a waiting room with the gameId
    function enterRoom(gameId) {
        // Get the player-info's form
        var form = document.getElementById('player-info');

        // Validate the form
        if (!form.elements["playerName"].checkValidity()) {
            form.elements["playerName"].reportValidity();
            return false;
        }

        // Make the gameId of the form == the gameId
        form.elements["gameId"].value = gameId;
        return true;
    }

    // Pull once to start
    setTimeout(pull, 1000);

    // Pull to get new list game state
    function pull() {
        $.ajax({
            url: "/WaitingRoom/ListGamesState",
            type: "GET",
            success: function (response) {
                if (!response.success) {
                    console.error("Error:", response.errorMessage);
                    return;
                }

                // Create a new list
                let newList = "";
                // add each game to the list
                for (const game of response.data) {
                    newList += `<div class="lobby-player animate-slide-in-left">
                        <div class="lobby-player__name">
                            <span class="lobby-player__indicator"></span>
                            ${game.creatingPlayerName}'s Game
                        </div>
                        <button type="submit" onclick="return enterRoom('${game.id}');" class="btn btn-sm btn-purple">Join</button>
                    </div>`;
                }

                // If no games available
                if (response.data.length === 0) {
                    newList = `<div class="text-center text-muted" style="padding: var(--space-xl);">
                        <p>No games available</p>
                        <p class="text-secondary" style="font-size: var(--text-sm);">Create a new game or enter a Game ID</p>
                    </div>`;
                }

                // set the available games to the new list
                document.getElementById("availableGames").innerHTML = newList;
            },
            error: function () {
                alert("ERROR - please try again");
            }
        });
        // Pull every 5 seconds
        setTimeout(pull, 5000);
        return false;
    }
</script>

<div class="lobby-container" style="max-width: 900px;">
    <div class="lobby-header">
        <h1 class="lobby-welcome heading-display">Join Game</h1>
        <p class="lobby-status" style="animation: none;">Find a game to join</p>
    </div>

    <form id="player-info" action="/WaitingRoom/EnterGame">
        <!-- Player Name Input -->
        <div class="auth-card animate-fade-in-up" style="max-width: 100%; margin-bottom: var(--space-xl);">
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="playerName">Your Name</label>
                <input class="form-input"
                       type="text"
                       id="playerName"
                       name="playerName"
                       maxlength="20"
                       autocomplete="off"
                       required
                       autofocus
                       placeholder="Enter your name">
            </div>
        </div>

        <div class="row" style="display: grid; grid-template-columns: 1fr; gap: var(--space-xl);">
            <!-- Available Games -->
            <div class="lobby-players animate-fade-in-up stagger-1" style="grid-column: 1;">
                <h3 class="lobby-players__title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: var(--space-sm); vertical-align: middle;">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    Available Games
                </h3>
                <div id="availableGames">
                    @if (Model.Count == 0)
                    {
                        <div class="text-center text-muted" style="padding: var(--space-xl);">
                            <p>No games available</p>
                            <p class="text-secondary" style="font-size: var(--text-sm);">Create a new game or enter a Game ID</p>
                        </div>
                    }
                    else
                    {
                        @for (int i = 0; i < Model.Count; i++)
                        {
                            <div class="lobby-player animate-slide-in-left">
                                <div class="lobby-player__name">
                                    <span class="lobby-player__indicator"></span>
                                    @Model[i].CreatingPlayerName's Game
                                </div>
                                <button type="submit" onclick="return enterRoom('@Model[i].Id');" class="btn btn-sm btn-purple">Join</button>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Enter Game Id -->
            <div class="lobby-players animate-fade-in-up stagger-2" style="grid-column: 1;">
                <h3 class="lobby-players__title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: var(--space-sm); vertical-align: middle;">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    Join by Game ID
                </h3>
                <div style="padding: var(--space-md);">
                    <div class="form-group">
                        <label class="form-label" for="gameId" style="font-size: var(--text-base);">Game ID</label>
                        <input class="form-input"
                               type="text"
                               id="gameId"
                               name="gameId"
                               maxlength="20"
                               autocomplete="off"
                               placeholder="Enter game ID">
                    </div>
                    <button type="submit" class="btn btn-outline-purple" style="width: 100%;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                        Join Game
                    </button>
                </div>
            </div>
        </div>
    </form>

    <div style="text-align: center; margin-top: var(--space-xl);">
        <a href="/" class="auth-back-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back to Home
        </a>
    </div>
</div>

@if (TempData["message"] != null)
{
    <script>
        alert('@TempData["message"]')
    </script>
}

<style>
    @@media (min-width: 768px) {
        .row {
            grid-template-columns: 1fr 1fr !important;
        }
        .row > div:first-child {
            grid-column: 1 !important;
        }
        .row > div:last-child {
            grid-column: 2 !important;
        }
    }
</style>
