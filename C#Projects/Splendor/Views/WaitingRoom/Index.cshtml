@model Splendor.Models.IPotentialGame
@{
    ViewData["Title"] = "Waiting Room";
}

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript">
    // Pull once to start
    setTimeout(pull, 1000);

    // Pull for new waiting room information
    function pull() {
        $.ajax({
            url: "/WaitingRoom/State/@ViewData["GameId"]/@ViewData["PlayerId"]",
            type: "GET",
            success: function (response) {
                if (!response.success) {
                    console.error("Error:", response.errorMessage);
                    return;
                }

                var data = response.data;
                // If there is the property players and the waiting room game state
                if (data.hasOwnProperty("players")) {
                    handleGameState(data);
                // else the player has been removed from the game or the game has started
                } else {
                    // If the player has been removed from the game
                    if (data == "removed from game") {
                        // Tell the player they have been removed from the game
                        alert("You have been removed from the game.");

                        // Redirect the player to the listgames view
                        location.href = "/WaitingRoom/ListGames";
                        return;
                    }
                    // Redirect the player to the game board
                    location.href = '/Game/Index?gameId=@ViewData["GameId"]&playerId=@ViewData["PlayerId"]';
                }
            },
            error: function () {
                alert("ERROR - please try again.");
            }
        });
        // Pull every 5 seconds
        setTimeout(pull, 5000);
        return false;
    }

    // Handle the response from the game state
    function handleGameState(response) {
        // Get the current players
        let currentPlayers = response.players;

        // create a new list of the current players
        let newList = "";

        // Whether or not the player is the creator
        let IsCreator = @ViewData["IsCreator"];

        // For each key in the current players
        for (const key in currentPlayers) {
            const isHost = key == 0;
            const playerClass = isHost ? 'lobby-player lobby-player--creator' : 'lobby-player';

            if (IsCreator && !isHost) {
                newList += `<div class="${playerClass} animate-slide-in-left">
                    <div class="lobby-player__name">
                        <span class="lobby-player__indicator"></span>
                        ${currentPlayers[key]}
                    </div>
                    <button onclick="remove(${key});" class="btn btn-sm btn-outline-darkPurple">Remove</button>
                </div>`;
            } else {
                newList += `<div class="${playerClass} animate-slide-in-left">
                    <div class="lobby-player__name">
                        <span class="lobby-player__indicator"></span>
                        ${currentPlayers[key]}
                    </div>
                </div>`;
            }
        }
        // add the list to the container
        document.getElementById("currentPlayers").innerHTML = newList;

        // Check to make sure we have enough, but not too many players
        if (2 <= Object.keys(currentPlayers).length && Object.keys(currentPlayers).length <= 4 && IsCreator) {
            document.getElementById("startGameButton").disabled = false;
        } else if (IsCreator) {
            document.getElementById("startGameButton").disabled = true;
        }
    }

    // Remove a player from the game
    function remove(id) {
        $.ajax({
            url: "/WaitingRoom/RemovePlayer/@ViewData["GameId"]/" + id,
            type: "GET",
            success: function (response) {
                if (!response.success) {
                    alert("ERROR - " + response.errorMessage);
                    return;
                }

                // Handle the response
                handleGameState(response.data);
            },
            error: function () {
                alert("ERROR - please try again.");
            }
        });
    }

    // Copy game ID to clipboard
    function copyGameId() {
        const gameId = '@Model.Id';
        navigator.clipboard.writeText(gameId).then(() => {
            // Show success feedback
            const button = document.getElementById('copyButton');
            const originalHTML = button.innerHTML;
            button.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"/>
            </svg>`;
            button.classList.add('copy-success');

            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('copy-success');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            alert('Failed to copy game ID');
        });
    }
</script>

<div class="lobby-container">
    <div class="lobby-header">
        <h1 class="lobby-welcome heading-display">Welcome @Model.Players[(int)ViewData["PlayerId"]]</h1>
        <p class="lobby-status">Waiting for players...</p>
        <div class="lobby-game-id-container">
            <span class="lobby-game-id">Game ID: @Model.Id</span>
            <button id="copyButton" onclick="copyGameId()" class="btn-copy" title="Copy game ID">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="lobby-players animate-fade-in-up">
        <h3 class="lobby-players__title">Current Players</h3>
        <div id="currentPlayers">
            @foreach (int key in Model.Players.Keys)
            {
                var isHost = key == 0;
                var playerClass = isHost ? "lobby-player lobby-player--creator" : "lobby-player";

                <div class="@playerClass animate-slide-in-left">
                    <div class="lobby-player__name">
                        <span class="lobby-player__indicator"></span>
                        @Model.Players[key]
                    </div>
                    @if (ViewData["IsCreator"]?.ToString() == "true" && !isHost)
                    {
                        <button onclick="remove(@key)" class="btn btn-sm btn-outline-darkPurple">Remove</button>
                    }
                </div>
            }
        </div>
    </div>

    @if (ViewData["IsCreator"]?.ToString() == "true")
    {
        <form action="/Game/Start" class="lobby-actions">
            <input type="hidden" id="gameId" name="gameId" value='@ViewData["GameId"]' />
            @if (Model.Players.Count >= 2)
            {
                <button id="startGameButton" class="btn btn-purple btn-lg" type="submit">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="5 3 19 12 5 21 5 3"/>
                    </svg>
                    Start Game
                </button>
            }
            else
            {
                <button id="startGameButton" disabled class="btn btn-purple btn-lg" type="submit">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="5 3 19 12 5 21 5 3"/>
                    </svg>
                    Start Game
                </button>
            }
        </form>
    }
</div>
